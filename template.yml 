AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'
Description: An AWS Lambda application that calls the Lambda API.
Resources:
  bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain

  MyDynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: Address
      AttributeDefinitions:
        - AttributeName: AddressId
          AttributeType: N
      KeySchema:
        - AttributeName: ID
          KeyType: HASH

  S3Handler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: app/build/distributions/app.zip
      Handler: com.aws.lambda.S3Handler
      Runtime: java11
      Description: Java function
      Role: arn:aws:iam::607695928816:role/Lambda-S3-Event
      MemorySize: 512
      Timeout: 30
      Tracing: Active
      Layers:
        - !Ref libs
      Events:
        s3Notification:
          Type: S3
          Properties:
            Bucket: !Ref bucket
            Events: s3:ObjectCreated:*
            Filter:
              S3Key:
                Rules:
                - Name: suffix
                  Value: .csv

  DestinationLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: app/build/distributions/app.zip
      Handler: com.aws.lambda.DestinationLambda
      Runtime: java11
      Description: Java function
      Role: arn:aws:iam::607695928816:role/lambda-dynamodb-read-access
      MemorySize: 512
      Timeout: 30
      Tracing: Active
      Layers:
        - !Ref libs

  libs:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: s3-java-lib
      Description: Dependencies for the Java S3 sample app.
      ContentUri: build/s3-java-lib.zip
      CompatibleRuntimes:
        - java8